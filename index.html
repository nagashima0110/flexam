<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4æŠã‚¯ã‚¤ã‚ºã‚¢ãƒ—ãƒª</title>
//    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans JP', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1));
            padding: 40px;
        }

        h1, h2 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }

        .mode-select-section,
        .quiz-section,
        .result-section,
        .admin-section,
        .login-section {
            display: none;
            padding: 20px;
            border-top: 1px solid #eee;
        }

        .card {
            background: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
        }

        .question-text {
            font-size: 1.1em;
            margin-bottom: 20px;
            line-height: 1.6;
            color: #444;
        }

        .choices label {
            display: block;
            margin-bottom: 15px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
            font-size: 1em;
        }

        .choices label:hover {
            background-color: #f5f5f5;
            border-color: #764ba2;
        }

        .choices input[type="radio"] {
            margin-right: 10px;
            transform: scale(1.2);
            accent-color: #667eea;
        }

        button {
            background-color: #667eea;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s, transform 0.1s;
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.4);
            width: 100%;
        }

        button:hover {
            background-color: #556ee0;
            transform: translateY(-1px);
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="password"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
        }

        .result-summary {
            text-align: center;
            padding: 20px;
            border-radius: 8px;
            background-color: #f9f9f9;
            margin-bottom: 20px;
        }

        .result-summary p {
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .result-summary .score {
            font-size: 2em;
            font-weight: bold;
            color: #764ba2;
        }

        .error-message {
            color: #e74c3c;
            text-align: center;
            margin-top: 15px;
            font-weight: bold;
        }

        .success-message {
            color: #2ecc71;
            text-align: center;
            margin-top: 15px;
            font-weight: bold;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .button-group button {
            width: auto;
            flex-grow: 1;
        }

        /* Mobile Adjustments */
        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }
            .button-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>4æŠã‚¯ã‚¤ã‚ºã‚¢ãƒ—ãƒª</h1>
    
    <!-- ãƒ­ã‚°ã‚¤ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div id="login-section" class="login-section card">
        <h2>ãƒ­ã‚°ã‚¤ãƒ³</h2>
        <div class="form-group">
            <label for="admin-password">ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
            <input type="password" id="admin-password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
        </div>
        <button onclick="checkAdminPassword()">ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</button>
        <div class="form-group" style="margin-top: 20px;">
            <label for="user-name">æ°å:</label>
            <input type="text" id="user-name" placeholder="ã‚ãªãŸã®æ°åã‚’å…¥åŠ›">
        </div>
        <div class="form-group">
            <label for="access-code">ã‚¢ã‚¯ã‚»ã‚¹ã‚³ãƒ¼ãƒ‰:</label>
            <input type="text" id="access-code" placeholder="ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
        </div>
        <button onclick="startQuiz()">ã‚¯ã‚¤ã‚ºé–‹å§‹</button>
        <p id="login-message" class="error-message"></p>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ‰é¸æŠã‚»ã‚¯ã‚·ãƒ§ãƒ³ (ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸå¾Œ) -->
    <div id="mode-select-section" class="mode-select-section">
        <h2>ãƒ¢ãƒ¼ãƒ‰é¸æŠ</h2>
        <div class="button-group">
            <button onclick="showAdminSettings()">ã‚¯ã‚¤ã‚ºè¨­å®šï¼ˆç®¡ç†è€…ï¼‰</button>
            <button onclick="showLogin()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
    </div>

    <!-- ã‚¯ã‚¤ã‚ºè¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆç®¡ç†è€…ï¼‰ -->
    <div id="admin-section" class="admin-section card">
        <h2>ã‚¯ã‚¤ã‚ºè¨­å®š</h2>
        <div class="form-group">
            <label for="setting-access-code">ã‚¢ã‚¯ã‚»ã‚¹ã‚³ãƒ¼ãƒ‰ (ç”Ÿå¾’ç”¨):</label>
            <input type="text" id="setting-access-code" placeholder="ä¾‹: 2024CLASS_A">
        </div>
        <div class="form-group">
            <label for="num-questions">å‡ºé¡Œæ•°:</label>
            <input type="number" id="num-questions" value="10" min="1">
        </div>
        <div class="form-group">
            <label for="quiz-duration">åˆ¶é™æ™‚é–“ (åˆ†):</label>
            <input type="number" id="quiz-duration" value="30" min="5">
        </div>
        <div class="form-group">
            <label for="sheet-url">CSVã¾ãŸã¯Google Sheets URL:</label>
            <input type="text" id="sheet-url" placeholder="CSVãƒ•ã‚¡ã‚¤ãƒ«ã¾ãŸã¯ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®URL">
        </div>
        <button onclick="generateAccessCode()">è¨­å®šã‚’ä¿å­˜</button>
        <button onclick="downloadAllResults()">å…¨çµæœãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ (CSV)</button>
        <p id="admin-message" class="success-message"></p>
        <p id="admin-error" class="error-message"></p>
        <button onclick="showModeSelect()" style="margin-top: 20px; background-color: #7f8c8d;">æˆ»ã‚‹</button>
    </div>

    <!-- ã‚¯ã‚¤ã‚ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div id="quiz-section" class="quiz-section card">
        <p id="timer" style="font-size: 1.2em; text-align: right; color: #e74c3c; margin-bottom: 10px; font-weight: bold;">æ®‹ã‚Šæ™‚é–“: 30:00</p>
        <p id="question-index" style="text-align: center; margin-bottom: 15px; font-weight: bold;"></p>
        <div class="question-text" id="question-text"></div>
        <div class="choices" id="choices"></div>
        <div class="button-group">
            <button onclick="nextQuestion()">æ¬¡ã¸</button>
            <button onclick="submitQuiz()" style="background-color: #e67e22;">çµ‚äº†ã—ã¦æ¡ç‚¹</button>
        </div>
    </div>

    <!-- çµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div id="result-section" class="result-section">
        <h2>æ¡ç‚¹çµæœ</h2>
        <div class="result-summary">
            <p>å—é¨“è€…: <span id="result-user-name"></span></p>
            <p>æ­£ç­”æ•°: <span id="result-correct-count" class="score"></span> / <span id="result-total-count"></span></p>
            <p>æ­£ç­”ç‡: <span id="result-percentage"></span>%</p>
        </div>
        <button onclick="downloadResults()">çµæœã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ (CSV)</button>
        <button onclick="restart()" style="background-color: #7f8c8d;">æœ€åˆã«æˆ»ã‚‹</button>
    </div>
</div>

<script>
    // ==========================================================
    // ğŸš¨ğŸš¨ğŸš¨ è¦ç¢ºèªãƒ»ä¿®æ­£ ğŸš¨ğŸš¨ğŸš¨
    // ä»¥ä¸‹ã® URL ã‚’ã€ã”è‡ªèº«ã® Web ã‚¢ãƒ—ãƒªã®ãƒ‡ãƒ—ãƒ­ã‚¤ URL ã«ç½®ãæ›ãˆã¦ãã ã•ã„ã€‚
    // https://script.google.com/macros/s/AKfycbxQWLT1x_5Pyx5jdy-6jyy9YcP2190WmmZehf-IqKUbfwyv2uV8Uc8bguyzW_oC59Ev/exec
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbxQWLT1x_5Pyx5jdy-6jyy9YcP2190WmmZehf-IqKUbfwyv2uV8Uc8bguyzW_oC59Ev/exec'; 
    // ==========================================================
    const ADMIN_PASSWORD = "admin"; // ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
    const RESULT_SHEET_NAME = 'QuizResults'; // GASå´ã®çµæœä¿å­˜ã‚·ãƒ¼ãƒˆå

    let userName = '';
    let currentQuestions = [];
    let allQuestions = []; // CSVã‹ã‚‰èª­ã¿è¾¼ã‚“ã å…¨å•é¡Œ
    let currentIndex = 0;
    let history = []; // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å›ç­”å±¥æ­´ã‚’ä¿å­˜
    let timerInterval;
    let quizDurationMinutes;
    let configData = null; // GASã‹ã‚‰å–å¾—ã—ãŸè¨­å®šãƒ‡ãƒ¼ã‚¿

    const sections = ['login-section', 'mode-select-section', 'quiz-section', 'result-section', 'admin-section'];

    function showSection(id) {
        sections.forEach(sectionId => {
            document.getElementById(sectionId).style.display = sectionId === id ? 'block' : 'none';
        });
    }

    // åˆæœŸè¡¨ç¤º
    showLogin();

    function showLogin() {
        showSection('login-section');
        document.getElementById('login-message').textContent = '';
    }

    function showModeSelect() {
        showSection('mode-select-section');
        document.getElementById('admin-message').textContent = '';
        document.getElementById('admin-error').textContent = '';
    }

    function showAdminSettings() {
        showSection('admin-section');
    }

    function checkAdminPassword() {
        const password = document.getElementById('admin-password').value;
        const message = document.getElementById('login-message');
        if (password === ADMIN_PASSWORD) {
            message.textContent = 'ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼';
            showModeSelect();
        } else {
            message.textContent = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚';
        }
    }

    /**
     * ã‚¢ã‚¯ã‚»ã‚¹ã‚³ãƒ¼ãƒ‰ã¨è¨­å®šã‚’GASã«POSTé€ä¿¡ã—ã¦ä¿å­˜ã™ã‚‹
     */
    async function generateAccessCode() {
        const code = document.getElementById('setting-access-code').value.trim();
        const numQuestions = parseInt(document.getElementById('num-questions').value);
        const duration = parseInt(document.getElementById('quiz-duration').value);
        const sheetUrl = document.getElementById('sheet-url').value.trim();
        const adminMessage = document.getElementById('admin-message');
        const adminError = document.getElementById('admin-error');

        adminMessage.textContent = '';
        adminError.textContent = '';

        if (!code || isNaN(numQuestions) || isNaN(duration) || !sheetUrl) {
            adminError.textContent = 'å…¨ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
            return;
        }

        const dataToSend = {
            accessCode: code,
            settings: {
                numQuestions: numQuestions,
                duration: duration,
                sheetUrl: sheetUrl
            }
        };

        // --- ğŸš¨ ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°è¿½åŠ  ğŸš¨ ---
        console.log('Sending data to GAS (POST):', dataToSend);
        // ------------------------------

        try {
            const response = await fetch(GAS_API_URL, {
                method: 'POST',
                mode: 'cors',
                cache: 'no-cache',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(dataToSend) // <--- ã“ã“ã§JSONæ–‡å­—åˆ—åŒ–ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
            });

            if (!response.ok) {
                // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã¾ãŸã¯GASã®å†…éƒ¨ã‚¨ãƒ©ãƒ¼
                throw new Error(`GAS API HTTP Error: ${response.status}`);
            }

            const result = await response.json();

            if (result.status === 'success') {
                adminMessage.textContent = `è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚ã‚¢ã‚¯ã‚»ã‚¹ã‚³ãƒ¼ãƒ‰: ${result.code}`;
                adminError.textContent = '';
            } else {
                adminError.textContent = `GAS API Error: ${result.message}`;
            }
        } catch (error) {
            console.error("Fetch Error:", error);
            // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’æ”¹å–„
            adminError.textContent = `GAS API Error: ${error.message}. Please check Console for details.`;
            // å…ƒã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è§£æã—ã€CORSã®å¯èƒ½æ€§ãŒã‚ã‚Œã°æ˜è¨˜
            if (error.message.includes("Failed to fetch") || error.message.includes("CORS")) {
                adminError.textContent += " (CORSã¾ãŸã¯ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚¨ãƒ©ãƒ¼ã®å¯èƒ½æ€§ã‚ã‚Šã€‚GASã®ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šã‚’å†ç¢ºèªã—ã¦ãã ã•ã„ã€‚)";
            }
        }
    }

    /**
     * ã‚¯ã‚¤ã‚ºè¨­å®šã‚’å–å¾—ã—ã€ã‚¯ã‚¤ã‚ºã‚’é–‹å§‹ã™ã‚‹
     */
    async function startQuiz() {
        userName = document.getElementById('user-name').value.trim();
        const accessCode = document.getElementById('access-code').value.trim();
        const loginMessage = document.getElementById('login-message');

        loginMessage.textContent = '';
        if (!userName || !accessCode) {
            loginMessage.textContent = 'æ°åã¨ã‚¢ã‚¯ã‚»ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
            return;
        }

        // --- ğŸš¨ ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°è¿½åŠ  ğŸš¨ ---
        console.log(`Fetching quiz config for code: ${accessCode} (GET)`);
        // ------------------------------
        
        try {
            // GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã‚¢ã‚¯ã‚»ã‚¹ã‚³ãƒ¼ãƒ‰è¨­å®šã‚’å–å¾—
            const response = await fetch(GAS_API_URL + `?code=${encodeURIComponent(accessCode)}`, {
                method: 'GET',
                mode: 'cors',
                cache: 'no-cache'
            });

            if (!response.ok) {
                throw new Error(`GAS API HTTP Error: ${response.status}`);
            }

            const result = await response.json();

            if (result.status === 'success') {
                configData = result;
                // ã‚¢ã‚¯ã‚»ã‚¹ã‚³ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯
                if (result.accessCode !== accessCode) {
                    loginMessage.textContent = 'ç„¡åŠ¹ãªã‚¢ã‚¯ã‚»ã‚¹ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚';
                    return;
                }

                // ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰
                await loadQuestions(result.settings.sheetUrl);
                quizDurationMinutes = result.settings.duration;
                
                // åˆ¶é™æ™‚é–“ã«åŸºã¥ã„ã¦å‡ºé¡Œæ•°ã‚’èª¿æ•´ï¼ˆè¨­å®šã•ã‚ŒãŸå‡ºé¡Œæ•°ãŒå…¨å•é¡Œæ•°ã‚’è¶…ãˆãªã„ã‚ˆã†ã«ï¼‰
                const maxQuestions = Math.min(result.settings.numQuestions, allQuestions.length);
                currentQuestions = shuffleArray([...allQuestions]).slice(0, maxQuestions);

                currentIndex = 0;
                history = [];
                startTimer();
                showQuiz();

            } else {
                loginMessage.textContent = `GAS API Error: ${result.message}ã€‚ã‚³ãƒ¼ãƒ‰ã‚’å†ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;
            }
        } catch (error) {
            console.error("Fetch Error:", error);
            loginMessage.textContent = `æ¥ç¶šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}ã€‚GASã®ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šã‚’å†ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;
        }
    }

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    async function loadQuestions(url) {
        const sheetIdMatch = url.match(/spreadsheets\/d\/([a-zA-Z0-9_-]+)/);
        let fetchUrl;

        if (sheetIdMatch) {
            // Google Spreadsheet URLã®å ´åˆã€CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆURLã‚’æ§‹æˆ
            const sheetId = sheetIdMatch[1];
            // æœ€åˆã®ã‚·ãƒ¼ãƒˆã®CSVã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹URL
            fetchUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&gid=0`;
        } else {
            // CSVãƒ•ã‚¡ã‚¤ãƒ«ç›´ãƒªãƒ³ã‚¯ã®å ´åˆ
            fetchUrl = url;
        }

        try {
            const response = await fetch(fetchUrl);
            if (!response.ok) {
                throw new Error('ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚URLã¾ãŸã¯å…±æœ‰è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }
            const csvText = await response.text();
            
            // PapaParseã‚’ä½¿ç”¨ã—ã¦CSVã‚’ãƒ‘ãƒ¼ã‚¹
            const result = Papa.parse(csvText, { header: true, skipEmptyLines: true });

            if (result.errors.length > 0) {
                console.error("PapaParse Errors:", result.errors);
                throw new Error('CSVãƒ‡ãƒ¼ã‚¿ã®è§£æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }

            // æœŸå¾…ã™ã‚‹ã‚«ãƒ©ãƒ : 'Question', 'A', 'B', 'C', 'D', 'Answer'
            allQuestions = result.data.map((row, index) => {
                const choices = [row.A, row.B, row.C, row.D].filter(c => c && c.trim() !== '');
                if (!row.Question || choices.length < 2 || !row.Answer) {
                    console.warn(`Row ${index + 2} skipped due to missing required fields.`);
                    return null; // ä¸å®Œå…¨ãªè¡Œã¯ã‚¹ã‚­ãƒƒãƒ—
                }

                return {
                    id: index + 1,
                    text: row.Question,
                    choices: choices,
                    correctAnswer: row.Answer.trim().toUpperCase() // A, B, C, D ã®ã„ãšã‚Œã‹
                };
            }).filter(q => q !== null);

            if (allQuestions.length === 0) {
                throw new Error('æœ‰åŠ¹ãªå•é¡ŒãŒCSVã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }

        } catch (error) {
            console.error("Load Questions Error:", error);
            document.getElementById('login-message').textContent = `ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ã®ãƒ­ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼: ${error.message}`;
            throw error; // startQuizé–¢æ•°ã«ã‚¨ãƒ©ãƒ¼ã‚’ä¼ãˆã‚‹
        }
    }


    function startTimer() {
        let timeLeft = quizDurationMinutes * 60;
        const timerElement = document.getElementById('timer');
        clearInterval(timerInterval);

        function updateTimer() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timerElement.textContent = `æ®‹ã‚Šæ™‚é–“: ${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                submitQuiz(); // æ™‚é–“åˆ‡ã‚Œã§æå‡º
            } else {
                timeLeft--;
            }
        }

        updateTimer();
        timerInterval = setInterval(updateTimer, 1000);
    }

    function showQuiz() {
        showSection('quiz-section');
        renderQuestion(currentIndex);
    }

    function renderQuestion(index) {
        if (index >= currentQuestions.length) {
            submitQuiz();
            return;
        }

        const q = currentQuestions[index];
        document.getElementById('question-index').textContent = `å•é¡Œ ${index + 1} / ${currentQuestions.length}`;
        document.getElementById('question-text').innerHTML = q.text.replace(/\n/g, '<br>'); // æ”¹è¡Œå¯¾å¿œ

        const choicesDiv = document.getElementById('choices');
        choicesDiv.innerHTML = '';
        
        q.choices.forEach((choice, i) => {
            const choiceLetter = String.fromCharCode(65 + i); // 65ã¯'A'ã®ASCIIã‚³ãƒ¼ãƒ‰
            const choiceId = `choice-${index}-${choiceLetter}`;
            const isChecked = history[index] && history[index].selectedAnswer === choiceLetter;

            const label = document.createElement('label');
            label.setAttribute('for', choiceId);
            label.innerHTML = `
                <input type="radio" id="${choiceId}" name="question-${index}" value="${choiceLetter}" ${isChecked ? 'checked' : ''}>
                <strong>${choiceLetter}.</strong> ${choice.replace(/\n/g, '<br>')}
            `;
            choicesDiv.appendChild(label);
        });

        // ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®èª¿æ•´
        const nextButton = document.querySelector('#quiz-section button:first-child');
        nextButton.textContent = (index === currentQuestions.length - 1) ? 'æœ€çµ‚ç¢ºèª' : 'æ¬¡ã¸';
    }

    function nextQuestion() {
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é¸æŠã‚’è¨˜éŒ²
        const selectedRadio = document.querySelector(`input[name="question-${currentIndex}"]:checked`);
        const selectedAnswer = selectedRadio ? selectedRadio.value : null;

        if (selectedAnswer) {
            const q = currentQuestions[currentIndex];
            const isCorrect = selectedAnswer === q.correctAnswer;
            
            history[currentIndex] = {
                questionId: q.id,
                questionText: q.text,
                selectedAnswer: selectedAnswer,
                correctAnswer: q.correctAnswer,
                isCorrect: isCorrect,
                timestamp: new Date().toISOString()
            };
        } else if (history[currentIndex]) {
            // å›ç­”ãŒè§£é™¤ã•ã‚ŒãŸå ´åˆã‚’è€ƒæ…®ã™ã‚‹ãªã‚‰ã€ã“ã“ã§ã¯nullã‚’ä¿å­˜ã™ã¹ãã ãŒã€ä»Šå›ã¯é¸æŠå¿…é ˆã¨ä»®å®š
            // ãŸã ã—ã€ä»Šå›ã¯ã€Œæœªå›ç­”ã€ã®çŠ¶æ…‹ã‚’è¨±å®¹ã™ã‚‹
            history[currentIndex] = {
                questionId: currentQuestions[currentIndex].id,
                questionText: currentQuestions[currentIndex].text,
                selectedAnswer: null,
                correctAnswer: currentQuestions[currentIndex].correctAnswer,
                isCorrect: false,
                timestamp: new Date().toISOString()
            };
        } else {
            // åˆã‚ã¦ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹å ´åˆã‚‚å±¥æ­´ã‚’ä½œæˆ
             history[currentIndex] = {
                questionId: currentQuestions[currentIndex].id,
                questionText: currentQuestions[currentIndex].text,
                selectedAnswer: null,
                correctAnswer: currentQuestions[currentIndex].correctAnswer,
                isCorrect: false,
                timestamp: new Date().toISOString()
            };
        }

        // æ¬¡ã®è³ªå•ã¸
        currentIndex++;
        if (currentIndex < currentQuestions.length) {
            renderQuestion(currentIndex);
        } else {
            submitQuiz();
        }
    }

    function submitQuiz() {
        clearInterval(timerInterval);
        
        // æœ€çµ‚å•é¡Œã®å›ç­”ã‚’ä¿å­˜ï¼ˆnextQuestionãŒå‘¼ã°ã‚Œã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ï¼‰
        const selectedRadio = document.querySelector(`input[name="question-${currentIndex}"]:checked`);
        const selectedAnswer = selectedRadio ? selectedRadio.value : null;

        if (currentIndex < currentQuestions.length) {
            const q = currentQuestions[currentIndex];
             history[currentIndex] = {
                questionId: q.id,
                questionText: q.text,
                selectedAnswer: selectedAnswer,
                correctAnswer: q.correctAnswer,
                isCorrect: selectedAnswer === q.correctAnswer,
                timestamp: new Date().toISOString()
            };
        }

        // æ¡ç‚¹
        const correctCount = history.filter(h => h && h.isCorrect).length;
        const totalCount = currentQuestions.length;
        const percentage = totalCount > 0 ? Math.round((correctCount / totalCount) * 100) : 0;

        document.getElementById('result-user-name').textContent = userName;
        document.getElementById('result-correct-count').textContent = correctCount;
        document.getElementById('result-total-count').textContent = totalCount;
        document.getElementById('result-percentage').textContent = percentage;

        // çµæœã‚’GASã«é€ä¿¡
        sendResultsToGAS(correctCount, totalCount, percentage);

        showSection('result-section');
    }

    /**
     * ã‚¯ã‚¤ã‚ºçµæœã‚’GASã«é€ä¿¡ã—ã¦ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜ã™ã‚‹
     */
    async function sendResultsToGAS(correctCount, totalCount, percentage) {
        const resultsData = {
            action: 'saveResults', // GASå´ã§å‡¦ç†ã‚’åˆ†å²ã•ã›ã‚‹ãŸã‚ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å
            userName: userName,
            accessCode: configData ? configData.accessCode : 'N/A',
            score: correctCount,
            total: totalCount,
            percentage: percentage,
            quizDuration: quizDurationMinutes,
            startTime: new Date().toISOString(),
            details: history // å€‹ã€…ã®å›ç­”å±¥æ­´
        };
        
        try {
            const response = await fetch(GAS_API_URL, {
                method: 'POST',
                mode: 'cors',
                cache: 'no-cache',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(resultsData)
            });

            const result = await response.json();

            if (result.status !== 'success') {
                console.error("GASçµæœä¿å­˜ã‚¨ãƒ©ãƒ¼:", result.message);
            }
        } catch (error) {
            console.error("çµæœé€ä¿¡ Fetch Error:", error);
        }
    }

    /**
     * çµæœã‚’CSVã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
     */
    function downloadResults() {
        if (history.length === 0) {
            alert('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹çµæœãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
            return;
        }

        try {
            const csvRows = [];
            // ãƒ˜ãƒƒãƒ€ãƒ¼
            csvRows.push([
                'æ°å', 
                'ã‚¢ã‚¯ã‚»ã‚¹ã‚³ãƒ¼ãƒ‰', 
                'å•é¡ŒID', 
                'å•é¡Œæ–‡', 
                'é¸æŠè‚¢',
                'é¸æŠã—ãŸå›ç­”', 
                'æ­£è§£', 
                'æ­£èª¤', 
                'å›ç­”æ™‚é–“'
            ]);

            history.forEach(h => {
                if (!h) return; // æœªå›ç­”ã§ã‚¹ã‚­ãƒƒãƒ—ã•ã‚ŒãŸå•é¡Œã¯å«ã‚ãªã„
                const question = currentQuestions.find(q => q.id === h.questionId);
                const choiceText = question ? question.choices.join(' | ') : 'N/A';
                
                csvRows.push([
                    userName.replace(/\"/g, '\"\"'), // CSVã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
                    (configData ? configData.accessCode : 'N/A').replace(/\"/g, '\"\"'),
                    h.questionId || '',
                    (h.questionText || '').replace(/\"/g, '\"\"'),
                    choiceText.replace(/\"/g, '\"\"'),
                    (h.selectedAnswer || '').replace(/\"/g, '\"\"'),
                    (h.correctAnswer || '').replace(/\"/g, '\"\"'),
                    h.isCorrect ? 'æ­£è§£' : 'ä¸æ­£è§£',
                    h.timestamp || ''
                ]);
            });

            const csvContent = csvRows.map(row => 
                row.map(cell => `"${cell}"`).join(',')
            ).join('\n');

            const bom = '\uFEFF';
            const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `quiz_results_${userName.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        } catch (error) {
            console.error("Download Error:", error);
        }
    }

    /**
     * å…¨çµæœãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ (GASã«è¦æ±‚)
     */
    async function downloadAllResults() {
        const adminMessage = document.getElementById('admin-message');
        const adminError = document.getElementById('admin-error');
        adminMessage.textContent = 'çµæœã‚’æº–å‚™ä¸­...';
        adminError.textContent = '';

        try {
            // GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã§çµæœãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const response = await fetch(GAS_API_URL + `?action=downloadAll`, {
                method: 'GET',
                mode: 'cors',
                cache: 'no-cache'
            });

            if (!response.ok) {
                throw new Error(`GAS API HTTP Error: ${response.status}`);
            }

            const result = await response.json();

            if (result.status === 'success' && result.csvContent) {
                // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å‡¦ç†
                const csvContent = result.csvContent;
                const bom = '\uFEFF';
                const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `all_quiz_results_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                adminMessage.textContent = 'å…¨çµæœã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚';
                adminError.textContent = '';
            } else {
                adminError.textContent = `GAS API Error: ${result.message || 'çµæœã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'}`;
            }
        } catch (error) {
            console.error("Download All Fetch Error:", error);
            adminError.textContent = `æ¥ç¶šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}ã€‚GASã®ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šã‚’å†ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;
        }
    }

    // ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ
    function restart() {
        document.getElementById('user-name').value = '';
        document.getElementById('access-code').value = '';
        userName = '';
        currentQuestions = [];
        currentIndex = 0;
        history = [];
        showLogin(); // ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ã§ã¯ãªã„å ´åˆã¯ãƒ­ã‚°ã‚¤ãƒ³ã«æˆ»ã‚‹
    }
</script>

<!-- Papa Parse Library (å¤–éƒ¨CDNã®ä»£ã‚ã‚Šã«ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’ä½¿ç”¨) -->
<!-- <script src="papaparse.min.js"></script> ãŒheadã«æŒ‡å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’å‰æã¨ã—ã¾ã™ -->
</body>
</html>
