<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4択クイズアプリ</title>
//    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans JP', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1));
            padding: 40px;
        }

        h1, h2 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }

        .mode-select-section,
        .quiz-section,
        .result-section,
        .admin-section,
        .login-section {
            display: none;
            padding: 20px;
            border-top: 1px solid #eee;
        }

        .card {
            background: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
        }

        .question-text {
            font-size: 1.1em;
            margin-bottom: 20px;
            line-height: 1.6;
            color: #444;
        }

        .choices label {
            display: block;
            margin-bottom: 15px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
            font-size: 1em;
        }

        .choices label:hover {
            background-color: #f5f5f5;
            border-color: #764ba2;
        }

        .choices input[type="radio"] {
            margin-right: 10px;
            transform: scale(1.2);
            accent-color: #667eea;
        }

        button {
            background-color: #667eea;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s, transform 0.1s;
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.4);
            width: 100%;
        }

        button:hover {
            background-color: #556ee0;
            transform: translateY(-1px);
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="password"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
        }

        .result-summary {
            text-align: center;
            padding: 20px;
            border-radius: 8px;
            background-color: #f9f9f9;
            margin-bottom: 20px;
        }

        .result-summary p {
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .result-summary .score {
            font-size: 2em;
            font-weight: bold;
            color: #764ba2;
        }

        .error-message {
            color: #e74c3c;
            text-align: center;
            margin-top: 15px;
            font-weight: bold;
        }

        .success-message {
            color: #2ecc71;
            text-align: center;
            margin-top: 15px;
            font-weight: bold;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .button-group button {
            width: auto;
            flex-grow: 1;
        }

        /* Mobile Adjustments */
        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }
            .button-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>4択クイズアプリ</h1>
    
    <!-- ログインセクション -->
    <div id="login-section" class="login-section card">
        <h2>ログイン</h2>
        <div class="form-group">
            <label for="admin-password">管理者パスワード:</label>
            <input type="password" id="admin-password" placeholder="パスワードを入力">
        </div>
        <button onclick="checkAdminPassword()">管理者ログイン</button>
        <div class="form-group" style="margin-top: 20px;">
            <label for="user-name">氏名:</label>
            <input type="text" id="user-name" placeholder="あなたの氏名を入力">
        </div>
        <div class="form-group">
            <label for="access-code">アクセスコード:</label>
            <input type="text" id="access-code" placeholder="コードを入力">
        </div>
        <button onclick="startQuiz()">クイズ開始</button>
        <p id="login-message" class="error-message"></p>
    </div>

    <!-- モード選択セクション (管理者ログイン成功後) -->
    <div id="mode-select-section" class="mode-select-section">
        <h2>モード選択</h2>
        <div class="button-group">
            <button onclick="showAdminSettings()">クイズ設定（管理者）</button>
            <button onclick="showLogin()">ログアウト</button>
        </div>
    </div>

    <!-- クイズ設定セクション（管理者） -->
    <div id="admin-section" class="admin-section card">
        <h2>クイズ設定</h2>
        <div class="form-group">
            <label for="setting-access-code">アクセスコード (生徒用):</label>
            <input type="text" id="setting-access-code" placeholder="例: 2024CLASS_A">
        </div>
        <div class="form-group">
            <label for="num-questions">出題数:</label>
            <input type="number" id="num-questions" value="10" min="1">
        </div>
        <div class="form-group">
            <label for="quiz-duration">制限時間 (分):</label>
            <input type="number" id="quiz-duration" value="30" min="5">
        </div>
        <div class="form-group">
            <label for="sheet-url">CSVまたはGoogle Sheets URL:</label>
            <input type="text" id="sheet-url" placeholder="CSVファイルまたはスプレッドシートのURL">
        </div>
        <button onclick="generateAccessCode()">設定を保存</button>
        <button onclick="downloadAllResults()">全結果ダウンロード (CSV)</button>
        <p id="admin-message" class="success-message"></p>
        <p id="admin-error" class="error-message"></p>
        <button onclick="showModeSelect()" style="margin-top: 20px; background-color: #7f8c8d;">戻る</button>
    </div>

    <!-- クイズセクション -->
    <div id="quiz-section" class="quiz-section card">
        <p id="timer" style="font-size: 1.2em; text-align: right; color: #e74c3c; margin-bottom: 10px; font-weight: bold;">残り時間: 30:00</p>
        <p id="question-index" style="text-align: center; margin-bottom: 15px; font-weight: bold;"></p>
        <div class="question-text" id="question-text"></div>
        <div class="choices" id="choices"></div>
        <div class="button-group">
            <button onclick="nextQuestion()">次へ</button>
            <button onclick="submitQuiz()" style="background-color: #e67e22;">終了して採点</button>
        </div>
    </div>

    <!-- 結果セクション -->
    <div id="result-section" class="result-section">
        <h2>採点結果</h2>
        <div class="result-summary">
            <p>受験者: <span id="result-user-name"></span></p>
            <p>正答数: <span id="result-correct-count" class="score"></span> / <span id="result-total-count"></span></p>
            <p>正答率: <span id="result-percentage"></span>%</p>
        </div>
        <button onclick="downloadResults()">結果をダウンロード (CSV)</button>
        <button onclick="restart()" style="background-color: #7f8c8d;">最初に戻る</button>
    </div>
</div>

<script>
    // ==========================================================
    // 🚨🚨🚨 要確認・修正 🚨🚨🚨
    // 以下の URL を、ご自身の Web アプリのデプロイ URL に置き換えてください。
    // https://script.google.com/macros/s/AKfycbxQWLT1x_5Pyx5jdy-6jyy9YcP2190WmmZehf-IqKUbfwyv2uV8Uc8bguyzW_oC59Ev/exec
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbxQWLT1x_5Pyx5jdy-6jyy9YcP2190WmmZehf-IqKUbfwyv2uV8Uc8bguyzW_oC59Ev/exec'; 
    // ==========================================================
    const ADMIN_PASSWORD = "admin"; // 管理者パスワード
    const RESULT_SHEET_NAME = 'QuizResults'; // GAS側の結果保存シート名

    let userName = '';
    let currentQuestions = [];
    let allQuestions = []; // CSVから読み込んだ全問題
    let currentIndex = 0;
    let history = []; // ユーザーの回答履歴を保存
    let timerInterval;
    let quizDurationMinutes;
    let configData = null; // GASから取得した設定データ

    const sections = ['login-section', 'mode-select-section', 'quiz-section', 'result-section', 'admin-section'];

    function showSection(id) {
        sections.forEach(sectionId => {
            document.getElementById(sectionId).style.display = sectionId === id ? 'block' : 'none';
        });
    }

    // 初期表示
    showLogin();

    function showLogin() {
        showSection('login-section');
        document.getElementById('login-message').textContent = '';
    }

    function showModeSelect() {
        showSection('mode-select-section');
        document.getElementById('admin-message').textContent = '';
        document.getElementById('admin-error').textContent = '';
    }

    function showAdminSettings() {
        showSection('admin-section');
    }

    function checkAdminPassword() {
        const password = document.getElementById('admin-password').value;
        const message = document.getElementById('login-message');
        if (password === ADMIN_PASSWORD) {
            message.textContent = '管理者ログイン成功！';
            showModeSelect();
        } else {
            message.textContent = 'パスワードが違います。';
        }
    }

    /**
     * アクセスコードと設定をGASにPOST送信して保存する
     */
    async function generateAccessCode() {
        const code = document.getElementById('setting-access-code').value.trim();
        const numQuestions = parseInt(document.getElementById('num-questions').value);
        const duration = parseInt(document.getElementById('quiz-duration').value);
        const sheetUrl = document.getElementById('sheet-url').value.trim();
        const adminMessage = document.getElementById('admin-message');
        const adminError = document.getElementById('admin-error');

        adminMessage.textContent = '';
        adminError.textContent = '';

        if (!code || isNaN(numQuestions) || isNaN(duration) || !sheetUrl) {
            adminError.textContent = '全ての項目を入力してください。';
            return;
        }

        const dataToSend = {
            accessCode: code,
            settings: {
                numQuestions: numQuestions,
                duration: duration,
                sheetUrl: sheetUrl
            }
        };

        // --- 🚨 デバッグ用ログ追加 🚨 ---
        console.log('Sending data to GAS (POST):', dataToSend);
        // ------------------------------

        try {
            const response = await fetch(GAS_API_URL, {
                method: 'POST',
                mode: 'cors',
                cache: 'no-cache',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(dataToSend) // <--- ここでJSON文字列化していることを確認
            });

            if (!response.ok) {
                // ネットワークエラーまたはGASの内部エラー
                throw new Error(`GAS API HTTP Error: ${response.status}`);
            }

            const result = await response.json();

            if (result.status === 'success') {
                adminMessage.textContent = `設定を保存しました。アクセスコード: ${result.code}`;
                adminError.textContent = '';
            } else {
                adminError.textContent = `GAS API Error: ${result.message}`;
            }
        } catch (error) {
            console.error("Fetch Error:", error);
            // エラーログを改善
            adminError.textContent = `GAS API Error: ${error.message}. Please check Console for details.`;
            // 元のエラーメッセージを解析し、CORSの可能性があれば明記
            if (error.message.includes("Failed to fetch") || error.message.includes("CORS")) {
                adminError.textContent += " (CORSまたはネットワーク接続エラーの可能性あり。GASのデプロイ設定を再確認してください。)";
            }
        }
    }

    /**
     * クイズ設定を取得し、クイズを開始する
     */
    async function startQuiz() {
        userName = document.getElementById('user-name').value.trim();
        const accessCode = document.getElementById('access-code').value.trim();
        const loginMessage = document.getElementById('login-message');

        loginMessage.textContent = '';
        if (!userName || !accessCode) {
            loginMessage.textContent = '氏名とアクセスコードを入力してください。';
            return;
        }

        // --- 🚨 デバッグ用ログ追加 🚨 ---
        console.log(`Fetching quiz config for code: ${accessCode} (GET)`);
        // ------------------------------
        
        try {
            // GETリクエストでアクセスコード設定を取得
            const response = await fetch(GAS_API_URL + `?code=${encodeURIComponent(accessCode)}`, {
                method: 'GET',
                mode: 'cors',
                cache: 'no-cache'
            });

            if (!response.ok) {
                throw new Error(`GAS API HTTP Error: ${response.status}`);
            }

            const result = await response.json();

            if (result.status === 'success') {
                configData = result;
                // アクセスコードのチェック
                if (result.accessCode !== accessCode) {
                    loginMessage.textContent = '無効なアクセスコードです。';
                    return;
                }

                // クイズデータをロード
                await loadQuestions(result.settings.sheetUrl);
                quizDurationMinutes = result.settings.duration;
                
                // 制限時間に基づいて出題数を調整（設定された出題数が全問題数を超えないように）
                const maxQuestions = Math.min(result.settings.numQuestions, allQuestions.length);
                currentQuestions = shuffleArray([...allQuestions]).slice(0, maxQuestions);

                currentIndex = 0;
                history = [];
                startTimer();
                showQuiz();

            } else {
                loginMessage.textContent = `GAS API Error: ${result.message}。コードを再確認してください。`;
            }
        } catch (error) {
            console.error("Fetch Error:", error);
            loginMessage.textContent = `接続エラーが発生しました: ${error.message}。GASのデプロイ設定を再確認してください。`;
        }
    }

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    async function loadQuestions(url) {
        const sheetIdMatch = url.match(/spreadsheets\/d\/([a-zA-Z0-9_-]+)/);
        let fetchUrl;

        if (sheetIdMatch) {
            // Google Spreadsheet URLの場合、CSVエクスポートURLを構成
            const sheetId = sheetIdMatch[1];
            // 最初のシートのCSVをエクスポートするURL
            fetchUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&gid=0`;
        } else {
            // CSVファイル直リンクの場合
            fetchUrl = url;
        }

        try {
            const response = await fetch(fetchUrl);
            if (!response.ok) {
                throw new Error('クイズデータの取得に失敗しました。URLまたは共有設定を確認してください。');
            }
            const csvText = await response.text();
            
            // PapaParseを使用してCSVをパース
            const result = Papa.parse(csvText, { header: true, skipEmptyLines: true });

            if (result.errors.length > 0) {
                console.error("PapaParse Errors:", result.errors);
                throw new Error('CSVデータの解析中にエラーが発生しました。フォーマットを確認してください。');
            }

            // 期待するカラム: 'Question', 'A', 'B', 'C', 'D', 'Answer'
            allQuestions = result.data.map((row, index) => {
                const choices = [row.A, row.B, row.C, row.D].filter(c => c && c.trim() !== '');
                if (!row.Question || choices.length < 2 || !row.Answer) {
                    console.warn(`Row ${index + 2} skipped due to missing required fields.`);
                    return null; // 不完全な行はスキップ
                }

                return {
                    id: index + 1,
                    text: row.Question,
                    choices: choices,
                    correctAnswer: row.Answer.trim().toUpperCase() // A, B, C, D のいずれか
                };
            }).filter(q => q !== null);

            if (allQuestions.length === 0) {
                throw new Error('有効な問題がCSVに見つかりませんでした。データを確認してください。');
            }

        } catch (error) {
            console.error("Load Questions Error:", error);
            document.getElementById('login-message').textContent = `クイズデータのロード中にエラー: ${error.message}`;
            throw error; // startQuiz関数にエラーを伝える
        }
    }


    function startTimer() {
        let timeLeft = quizDurationMinutes * 60;
        const timerElement = document.getElementById('timer');
        clearInterval(timerInterval);

        function updateTimer() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timerElement.textContent = `残り時間: ${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                submitQuiz(); // 時間切れで提出
            } else {
                timeLeft--;
            }
        }

        updateTimer();
        timerInterval = setInterval(updateTimer, 1000);
    }

    function showQuiz() {
        showSection('quiz-section');
        renderQuestion(currentIndex);
    }

    function renderQuestion(index) {
        if (index >= currentQuestions.length) {
            submitQuiz();
            return;
        }

        const q = currentQuestions[index];
        document.getElementById('question-index').textContent = `問題 ${index + 1} / ${currentQuestions.length}`;
        document.getElementById('question-text').innerHTML = q.text.replace(/\n/g, '<br>'); // 改行対応

        const choicesDiv = document.getElementById('choices');
        choicesDiv.innerHTML = '';
        
        q.choices.forEach((choice, i) => {
            const choiceLetter = String.fromCharCode(65 + i); // 65は'A'のASCIIコード
            const choiceId = `choice-${index}-${choiceLetter}`;
            const isChecked = history[index] && history[index].selectedAnswer === choiceLetter;

            const label = document.createElement('label');
            label.setAttribute('for', choiceId);
            label.innerHTML = `
                <input type="radio" id="${choiceId}" name="question-${index}" value="${choiceLetter}" ${isChecked ? 'checked' : ''}>
                <strong>${choiceLetter}.</strong> ${choice.replace(/\n/g, '<br>')}
            `;
            choicesDiv.appendChild(label);
        });

        // ボタンテキストの調整
        const nextButton = document.querySelector('#quiz-section button:first-child');
        nextButton.textContent = (index === currentQuestions.length - 1) ? '最終確認' : '次へ';
    }

    function nextQuestion() {
        // ユーザーの選択を記録
        const selectedRadio = document.querySelector(`input[name="question-${currentIndex}"]:checked`);
        const selectedAnswer = selectedRadio ? selectedRadio.value : null;

        if (selectedAnswer) {
            const q = currentQuestions[currentIndex];
            const isCorrect = selectedAnswer === q.correctAnswer;
            
            history[currentIndex] = {
                questionId: q.id,
                questionText: q.text,
                selectedAnswer: selectedAnswer,
                correctAnswer: q.correctAnswer,
                isCorrect: isCorrect,
                timestamp: new Date().toISOString()
            };
        } else if (history[currentIndex]) {
            // 回答が解除された場合を考慮するなら、ここではnullを保存すべきだが、今回は選択必須と仮定
            // ただし、今回は「未回答」の状態を許容する
            history[currentIndex] = {
                questionId: currentQuestions[currentIndex].id,
                questionText: currentQuestions[currentIndex].text,
                selectedAnswer: null,
                correctAnswer: currentQuestions[currentIndex].correctAnswer,
                isCorrect: false,
                timestamp: new Date().toISOString()
            };
        } else {
            // 初めてスキップする場合も履歴を作成
             history[currentIndex] = {
                questionId: currentQuestions[currentIndex].id,
                questionText: currentQuestions[currentIndex].text,
                selectedAnswer: null,
                correctAnswer: currentQuestions[currentIndex].correctAnswer,
                isCorrect: false,
                timestamp: new Date().toISOString()
            };
        }

        // 次の質問へ
        currentIndex++;
        if (currentIndex < currentQuestions.length) {
            renderQuestion(currentIndex);
        } else {
            submitQuiz();
        }
    }

    function submitQuiz() {
        clearInterval(timerInterval);
        
        // 最終問題の回答を保存（nextQuestionが呼ばれていない可能性があるため）
        const selectedRadio = document.querySelector(`input[name="question-${currentIndex}"]:checked`);
        const selectedAnswer = selectedRadio ? selectedRadio.value : null;

        if (currentIndex < currentQuestions.length) {
            const q = currentQuestions[currentIndex];
             history[currentIndex] = {
                questionId: q.id,
                questionText: q.text,
                selectedAnswer: selectedAnswer,
                correctAnswer: q.correctAnswer,
                isCorrect: selectedAnswer === q.correctAnswer,
                timestamp: new Date().toISOString()
            };
        }

        // 採点
        const correctCount = history.filter(h => h && h.isCorrect).length;
        const totalCount = currentQuestions.length;
        const percentage = totalCount > 0 ? Math.round((correctCount / totalCount) * 100) : 0;

        document.getElementById('result-user-name').textContent = userName;
        document.getElementById('result-correct-count').textContent = correctCount;
        document.getElementById('result-total-count').textContent = totalCount;
        document.getElementById('result-percentage').textContent = percentage;

        // 結果をGASに送信
        sendResultsToGAS(correctCount, totalCount, percentage);

        showSection('result-section');
    }

    /**
     * クイズ結果をGASに送信してスプレッドシートに保存する
     */
    async function sendResultsToGAS(correctCount, totalCount, percentage) {
        const resultsData = {
            action: 'saveResults', // GAS側で処理を分岐させるためのアクション名
            userName: userName,
            accessCode: configData ? configData.accessCode : 'N/A',
            score: correctCount,
            total: totalCount,
            percentage: percentage,
            quizDuration: quizDurationMinutes,
            startTime: new Date().toISOString(),
            details: history // 個々の回答履歴
        };
        
        try {
            const response = await fetch(GAS_API_URL, {
                method: 'POST',
                mode: 'cors',
                cache: 'no-cache',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(resultsData)
            });

            const result = await response.json();

            if (result.status !== 'success') {
                console.error("GAS結果保存エラー:", result.message);
            }
        } catch (error) {
            console.error("結果送信 Fetch Error:", error);
        }
    }

    /**
     * 結果をCSVとしてダウンロード
     */
    function downloadResults() {
        if (history.length === 0) {
            alert('ダウンロードする結果がありません。');
            return;
        }

        try {
            const csvRows = [];
            // ヘッダー
            csvRows.push([
                '氏名', 
                'アクセスコード', 
                '問題ID', 
                '問題文', 
                '選択肢',
                '選択した回答', 
                '正解', 
                '正誤', 
                '回答時間'
            ]);

            history.forEach(h => {
                if (!h) return; // 未回答でスキップされた問題は含めない
                const question = currentQuestions.find(q => q.id === h.questionId);
                const choiceText = question ? question.choices.join(' | ') : 'N/A';
                
                csvRows.push([
                    userName.replace(/\"/g, '\"\"'), // CSVエスケープ
                    (configData ? configData.accessCode : 'N/A').replace(/\"/g, '\"\"'),
                    h.questionId || '',
                    (h.questionText || '').replace(/\"/g, '\"\"'),
                    choiceText.replace(/\"/g, '\"\"'),
                    (h.selectedAnswer || '').replace(/\"/g, '\"\"'),
                    (h.correctAnswer || '').replace(/\"/g, '\"\"'),
                    h.isCorrect ? '正解' : '不正解',
                    h.timestamp || ''
                ]);
            });

            const csvContent = csvRows.map(row => 
                row.map(cell => `"${cell}"`).join(',')
            ).join('\n');

            const bom = '\uFEFF';
            const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `quiz_results_${userName.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        } catch (error) {
            console.error("Download Error:", error);
        }
    }

    /**
     * 全結果ダウンロード (GASに要求)
     */
    async function downloadAllResults() {
        const adminMessage = document.getElementById('admin-message');
        const adminError = document.getElementById('admin-error');
        adminMessage.textContent = '結果を準備中...';
        adminError.textContent = '';

        try {
            // GETリクエストで結果データを取得
            const response = await fetch(GAS_API_URL + `?action=downloadAll`, {
                method: 'GET',
                mode: 'cors',
                cache: 'no-cache'
            });

            if (!response.ok) {
                throw new Error(`GAS API HTTP Error: ${response.status}`);
            }

            const result = await response.json();

            if (result.status === 'success' && result.csvContent) {
                // ダウンロード処理
                const csvContent = result.csvContent;
                const bom = '\uFEFF';
                const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `all_quiz_results_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                adminMessage.textContent = '全結果をダウンロードしました。';
                adminError.textContent = '';
            } else {
                adminError.textContent = `GAS API Error: ${result.message || '結果の取得に失敗しました。'}`;
            }
        } catch (error) {
            console.error("Download All Fetch Error:", error);
            adminError.textContent = `接続エラーが発生しました: ${error.message}。GASのデプロイ設定を再確認してください。`;
        }
    }

    // リスタート
    function restart() {
        document.getElementById('user-name').value = '';
        document.getElementById('access-code').value = '';
        userName = '';
        currentQuestions = [];
        currentIndex = 0;
        history = [];
        showLogin(); // 管理者モードではない場合はログインに戻る
    }
</script>

<!-- Papa Parse Library (外部CDNの代わりにファイルパスを使用) -->
<!-- <script src="papaparse.min.js"></script> がheadに指定されていることを前提とします -->
</body>
</html>
